
<div id="canvasPlaceholder"></div>
<div id="canvasPlaceholder2"></div>

<button id="refresh">Refresh</button>
<button id="select">Select</button>

<script>

async function decode(canvas, ctx, bytes, scale = 1) {
  const url = URL.createObjectURL(new Blob([bytes]))
  
  const image = await new Promise((resolve, reject) => {
    const img = new Image()
    img.onload = () => resolve(img)
    img.onerror = () => reject()
    img.src = url
  })

  canvas.width = image.width
  canvas.height = image.height
  canvas.style.width = ((canvas.width * scale) / 8) + "px"
  canvas.style.height = ((canvas.width * scale) / 8) + "px"
  ctx.drawImage(image, 0, 0)
  const imageData = ctx.getImageData(0, 0, image.width, image.height)
  return imageData
}

const example = document.querySelector('#example');
const canvasPlaceholder = document.querySelector('#canvasPlaceholder');
const canvas = document.createElement('canvas')
canvasPlaceholder.appendChild(canvas)
const ctx = canvas.getContext('2d')

const canvasPlaceholder2 = document.querySelector('#canvasPlaceholder2');
const canvas2 = document.createElement('canvas')
canvasPlaceholder2.appendChild(canvas2)
const ctx2 = canvas2.getContext('2d')


document.getElementById('refresh').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'refresh' } }, '*')
}

document.getElementById('select').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'select' } }, '*')
}


  window.onmessage = async (event) => {
    const bytes = event.data.pluginMessage
    const imageData = await decode(canvas, ctx, bytes)
    const imageData2 = await decode(canvas2, ctx2, bytes, 4)
  }

</script>
